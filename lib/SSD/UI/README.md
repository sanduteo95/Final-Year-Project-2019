To test out the various ways of applying the Futamura Projections on the GoI machine which is used to implement the Data Flow language, first clone the [EFSD-vis](https://github.com/sanduteo95/EFSD-vis) outside of this repository so that the folder structure is:
```
|-- tas458
|-- EFSD-vis
```
Then switch from `master` branch to `vis-term`.

Applying the First Futamura Projection on the GoI machine implies running Prepack on the JavaScript file containing the GoIMachine class i.e. `../EFSD-vis/js/goi-machine.js`. 

There are three ways this can be achieved, with the help of the following scripts:
1. `npm run v1-goi-machine`

Converts the `require.js` (amd) module defined in `goi-machine.js` into a plain JavaScript module (umd), optimized with the Prepack Webpack plugin (i.e. `goi-machine.prepack.js`). Then converts this back to a `require.js` (amd) module (i.e. `goi-machine.require.js`).

Problem with the following:
```
  var _$0 = this;

  var _$1 = _$0.Object;
  var _$2 = _$1.defineProperty;
  var _$3 = _$1.setPrototypeOf;
```

`this` does not have the expected values in the browser, so it fails. Instead of pointing at the `window`, it points at something else. Probably could be fixed within WebPack. Changing the value of `this` inside `call(this)` in the file generated by PrePack helps (to `window`).

Next error is: `TypeError: Machine is not a constructor`. Need to change the last line to `module.exports = _1_main;` from `global.main = _1_main`. But it's better fixed by adding `globalObject: 'window' libraryTarget: 'window'` to the `output` of the webpack configuration.

In the end, we were able to modify the WebPack to fix the `window` and `GoIMachine` problems above:
{
    test: require.resolve(basePath + '/goi-machine.js'),
    use: [
        'import-loader?this=>window'
    ]
}
Next: `TypeError: graph.addNode is not a function`. Because of this line `graph = this.graph; // cheating!`. Graph won't be defined at that point I don't think, because it was defined in a place it shouldn't be. Fix in the visualiser with: https://stackoverflow.com/questions/23476732/set-javascript-global-variables-across-multiple-pages. Or in Webpack with :
```
new webpack.DefinePlugin({
    "graph": null
})
```

However, next error is `TypeError: term.prin is undefined` which I think is because of the use of the Webpack fix (might mean graph doesn't change?)

2. `npm run v2-goi-machine`

Converts the `require.js` (amd) module defined in `goi-machine.js` into a plain JavaScript module (umd) (i.e. `goi-machine.js`). Then runs Prepack separately on that file and returns an optimized file (i.e. `goi-machine.prepack.js`), which it then converts this back to a `require.js` (amd) module (i.e. `goi-machine.require.js`).

This one fails as well, but with a different error: `TypeError: Super expression must either be null or a function`. This is referring to when we try to create a `Thunk` from a `Term`. At first it might look like it could be because the Term is defined after the Thunk (look for `_W_Thunk` in `goi-machine.prepack.js`). However, even moving that before manually causes problems.

Moving the following code before the `_W_Thunk` function works:
```
  var _1i_Term = class {
    constructor(ctx) {
      this.ctx = ctx;
    }

  };
```
But then the problem is with `_c_IntOp` (again that `_u_Op` is `undefined`). But can be fixed the same way by moving it inside Prepack. (need to figure out an automated way to do this)

Next two errors are the ones from the first case.

3. `npm run v3-goi-machine`

Runs Prepack directly o the `require.js` (amd) module defined in `goi-machine.js` and returns a new optimized module (i.e. `goi-machine.prepack.js`). This requires a bit of fiddling with the Prepack configuration and adding extra code. Then converts this back to a `require.js` (amd) module (i.e. `goi-machine.require.js`).

This third version seems inefficient and too fiddly. Would need to make sure to require all dependencies and include them into the file, something that Webpack is able to do very easily. So this version will be forgotten.

Changes that went into `EFSD-vis`:
- remove multiple module definitions from one file, and split them into files in folders, and remove require.js bundles configuration (which will not be necessary anymore): see https://requirejs.org/docs/api.html#define for why
- use require.js define syntax (define(<name>, [<deps>], function(<deps class names>) { ... })): see https://requirejs.org/docs/api.html#funcmodule which explains how this syntax works and why the other syntax would work, but doesn't seem necessary in this case
- replace "var graph" (cheating method) with "window.mainGraph"

To run the GoI Machine in terminal, first we clone the [itf-impl](https://git.cs.bham.ac.uk/wtc488/itf-impl) outside of this repository so that the folder structure is:
```
|-- tas458
|-- itf-impl
```
Then switch from `master` branch to `vis-term`. Then we attempted two methods:

1. Try to compile `goi-machine.js` inside `Node.js` and convert `app.js` into a `Node.js` function (see `webpack.config.js`)
- Webpack `goi-machine.js` in `Visualiser` into an `commonjs2` module, so that we can require it in `Node.js`
- The result will be `goi-machine.js`, which we can test it works by requiring the GoI Machine as `const machine = require('./goi-machine.js');`
- We can test that works by running `node index.js -i input/SSD/basic.ssd -g` and seeing the result `"5,-,□"`
- Then we need to run Prepack on the `interpret` function, which is basically the interpreter for the GoI Machine
- The problem is we will need to require the GoIMachine and Prepack can't deal with that very well from experience, so we'll try now to create the ineterpreter inside the GoIMachine directly

2. Try to compile `app.js` directly (see `webpack2.config.js`)
- Webpack `app.js` in `Visualiser` into a `commonjs2` or `var` module, so that we can run the interpreter and  apply Prepack to it by reading the file into the prepack source and doing `app.interpret(...)`, respectively
- The result will be `app.js`, which we can test it works by running `node index.js -i input/SSD/basic.ssd -g` and seeing the result `"5,-,□"` (make sure to change `libraryTarget` to `commonjs2` or add `module.exports = app` at the end of the generated file)
- Needed to change `app.js` so it doesn't require anything and it exports the `interpret` function.

